<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Aulas y Reservas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 30px;
            min-height: 400px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: #000;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }

        .card-body {
            color: #495057;
        }

        .card-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            font-size: 0.95em;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.8em;
        }

        .close {
            font-size: 2em;
            cursor: pointer;
            color: #adb5bd;
            line-height: 1;
        }

        .close:hover {
            color: #495057;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #adb5bd;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .horarios-list {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .tramoHorario-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #dee2e6;
        }

        .tramoHorario-item:last-child {
            margin-bottom: 0;
        }

        .horarios-container {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
            margin-top: 20px;
        }

        .tramoHorario-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .tramoHorario-form .form-group {
            margin-bottom: 0;
        }

        .tramoHorario-added {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tramoHorario-info {
            font-size: 0.95em;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .horarios-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .horarios-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè´ Sistema de Gesti√≥n de Aulas</h1>
            <p>Administraci√≥n de aulas, reservas y horarios</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="changeTab('aulas')">üèõÔ∏è Aulas</button>
            <button class="tab" onclick="changeTab('reservas')">üìÖ Reservas</button>
        </div>

        <div class="content">
            <div class="toolbar">
                <h2 id="sectionTitle">Listado de Aulas</h2>
                <button class="btn btn-primary" id="mainActionBtn" onclick="openModal('aula')">
                    ‚ûï Nueva Aula
                </button>
            </div>

            <div id="aulasContent" class="grid"></div>
            <div id="reservasContent" class="grid" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal para Aula -->
    <div id="aulaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="aulaModalTitle">Nueva Aula</h2>
                <span class="close" onclick="closeModal('aulaModal')">&times;</span>
            </div>
            <form id="aulaForm" onsubmit="saveAula(event)">
                <div class="form-group">
                    <label>Nombre del Aula *</label>
                    <input type="text" class="form-control" id="aulaNombre" required>
                </div>
                <div class="form-group">
                    <label>Capacidad *</label>
                    <input type="number" class="form-control" id="aulaCapacidad" min="1" required>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="aulaEsOrdenadores" onchange="toggleOrdenadores()">
                        <label for="aulaEsOrdenadores">¬øEs aula de ordenadores?</label>
                    </div>
                </div>
                <div class="form-group" id="ordenadoresGroup" style="display: none;">
                    <label>N√∫mero de Ordenadores</label>
                    <input type="number" class="form-control" id="aulaNumOrdenadores" min="0" value="0">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('aulaModal')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üíæ Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Reserva -->
    <div id="reservaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="reservaModalTitle">Nueva Reserva</h2>
                <span class="close" onclick="closeModal('reservaModal')">&times;</span>
            </div>
            <div id="reservaAlert"></div>
            <form id="reservaForm" onsubmit="saveReserva(event)">
                <div class="form-group">
                    <label>Aula *</label>
                    <select class="form-control" id="reservaAula" required>
                        <option value="">Seleccione un aula</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" class="form-control" id="reservaFecha" required>
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de Asistentes *</label>
                        <input type="number" class="form-control" id="reservaAsistentes" min="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Motivo *</label>
                    <input type="text" class="form-control" id="reservaMotivo" required placeholder="Ej: Reuni√≥n de equipo, Clase de matem√°ticas...">
                </div>

                <!-- Secci√≥n de Horarios -->
                <div class="horarios-container">
                    <div class="horarios-title">
                        <h3 style="color: #667eea; margin: 0;">‚è∞ Horarios</h3>
                        <span class="horarios-count" id="horariosCount">0 horarios</span>
                    </div>
                    
                    <div class="tramoHorario-form">
                        <div class="form-group">
                            <label>D√≠a de la Semana</label>
                            <select class="form-control" id="horarioDia">
                                <option value="LUNES">Lunes</option>
                                <option value="MARTES">Martes</option>
                                <option value="MIERCOES">Mi√©rcoles</option>
                                <option value="JUEVES">Jueves</option>
                                <option value="VIERNES">Viernes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sesi√≥n del D√≠a</label>
                            <input type="number" class="form-control" id="horarioSesion" min="1" max="10" value="1">
                        </div>
                        <div class="form-group">
                            <label>Hora Inicio</label>
                            <input type="time" class="form-control" id="horarioInicio" value="09:00">
                        </div>
                        <div class="form-group">
                            <label>Hora Fin</label>
                            <input type="time" class="form-control" id="horarioFin" value="10:00">
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-success" onclick="addHorario()" style="width: 100%; margin-bottom: 15px;">
                        ‚ûï A√±adir Horario
                    </button>

                    <div id="horariosAdded" style="margin-top: 15px;"></div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('reservaModal')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üíæ Guardar Reserva
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let currentTab = 'aulas';
        let editingId = null;
        let aulasData = [];
        let reservasData = [];
        let horariosTemp = [];

        window.addEventListener('load', () => {
            loadAulas();
        });

        function changeTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const mainBtn = document.getElementById('mainActionBtn');

            if (tab === 'aulas') {
                document.getElementById('sectionTitle').textContent = 'Listado de Aulas';
                mainBtn.textContent = '‚ûï Nueva Aula';
                mainBtn.onclick = () => openModal('aula');
                document.getElementById('aulasContent').style.display = 'grid';
                document.getElementById('reservasContent').style.display = 'none';
                loadAulas();
            } else {
                document.getElementById('sectionTitle').textContent = 'Listado de Reservas';
                mainBtn.textContent = '‚ûï Nueva Reserva';
                mainBtn.onclick = () => openModal('reserva');
                document.getElementById('aulasContent').style.display = 'none';
                document.getElementById('reservasContent').style.display = 'grid';
                loadReservas();
            }
        }

        async function loadAulas() {
            const container = document.getElementById('aulasContent');
            container.innerHTML = '<div class="loading">‚è≥ Cargando aulas...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/aula`);
                if (!response.ok) throw new Error('Error al cargar aulas');
                
                aulasData = await response.json();
                
                if (aulasData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>üì≠ No hay aulas registradas</h3>
                            <p>Comienza agregando tu primera aula</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = aulasData.map(aula => `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${aula.nombre}</div>
                        </div>
                        <div class="card-body">
                            <div class="card-info">
                                üë• <strong>Capacidad:</strong> ${aula.capacidad} personas
                            </div>
                            <div class="card-info">
                                ${aula.esAulaOrdenadores ? 
                                    `üíª <strong>Ordenadores:</strong> ${aula.numeroOrdenadores || 0}` : 
                                    'üìö <strong>Tipo:</strong> Aula est√°ndar'}
                            </div>
                            <div class="card-info">
                                üìã <strong>Reservas:</strong> ${aula.reservas ? aula.reservas.length : 0}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-edit" onclick="editAula(${aula.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-danger" onclick="deleteAula(${aula.id})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><h3>‚ùå Error al cargar las aulas</h3><p>${error.message}</p></div>`;
                console.error('Error:', error);
            }
        }

        async function loadReservas() {
            const container = document.getElementById('reservasContent');
            container.innerHTML = '<div class="loading">‚è≥ Cargando reservas...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/reserva`);
                if (!response.ok) throw new Error('Error al cargar reservas');
                
                reservasData = await response.json();
                
                if (reservasData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>üì≠ No hay reservas registradas</h3>
                            <p>Comienza agregando tu primera reserva</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = reservasData.map(reserva => `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${reserva.motivo}</div>
                        </div>
                        <div class="card-body">
                            <div class="card-info">
                                üèõÔ∏è <strong>Aula:</strong> ${reserva.aula ? reserva.aula.nombre : 'N/A'}
                            </div>
                            <div class="card-info">
                                üìÖ <strong>Fecha:</strong> ${reserva.fecha}
                            </div>
                            <div class="card-info">
                                üë• <strong>Asistentes:</strong> ${reserva.numeroAsistentes}
                            </div>
                            ${reserva.tramoHorario && reserva.tramoHorario.length > 0 ? `
                                <div class="horarios-list">
                                    <strong>‚è∞ Horarios (${reserva.tramoHorario.length}):</strong>
                                    ${reserva.tramoHorario.map(h => `
                                        <div class="tramoHorario-item">
                                            <span><strong>${h.diasSemana}</strong> - Sesi√≥n ${h.sesionDia}</span>
                                            <span>${h.horarioInicio} - ${h.horarioFin}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div class="card-info">‚ö†Ô∏è Sin horarios asignados</div>'}
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-edit" onclick="editReserva(${reserva.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-danger" onclick="deleteReserva(${reserva.id})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><h3>‚ùå Error al cargar las reservas</h3><p>${error.message}</p></div>`;
                console.error('Error:', error);
            }
        }

        async function openModal(type) {
            editingId = null;
            horariosTemp = [];
            
            if (type === 'aula') {
                document.getElementById('aulaModalTitle').textContent = 'Nueva Aula';
                document.getElementById('aulaForm').reset();
                document.getElementById('ordenadoresGroup').style.display = 'none';
                document.getElementById('aulaModal').classList.add('active');
            } else {
                document.getElementById('reservaModalTitle').textContent = 'Nueva Reserva';
                document.getElementById('reservaForm').reset();
                document.getElementById('horariosAdded').innerHTML = '<p style="color: #6c757d; text-align: center; padding: 10px;">No hay horarios a√±adidos</p>';
                document.getElementById('reservaAlert').innerHTML = '';
                updateHorariosCount();
                await loadAulasSelect();
                document.getElementById('reservaModal').classList.add('active');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            horariosTemp = [];
        }

        function toggleOrdenadores() {
            const checkbox = document.getElementById('aulaEsOrdenadores');
            const group = document.getElementById('ordenadoresGroup');
            group.style.display = checkbox.checked ? 'block' : 'none';
            if (!checkbox.checked) {
                document.getElementById('aulaNumOrdenadores').value = '0';
            }
        }

        async function loadAulasSelect() {
            const select = document.getElementById('reservaAula');
            select.innerHTML = '<option value="">‚è≥ Cargando aulas...</option>';
            
            try {
                const response = await fetch(`${API_BASE}/aula`);
                if (!response.ok) throw new Error('Error al cargar aulas');
                
                const text = await response.text();
                let aulas;
                
                try {
                    aulas = JSON.parse(text);
                } catch (jsonError) {
                    console.error('Error parsing JSON:', text);
                    throw new Error('La respuesta del servidor no es v√°lida');
                }
                
                if (!Array.isArray(aulas)) {
                    throw new Error('La respuesta no es un array v√°lido');
                }
                
                if (aulas.length === 0) {
                    select.innerHTML = '<option value="">‚ùå No hay aulas disponibles</option>';
                    showAlert('‚ö†Ô∏è No hay aulas disponibles. Por favor, crea un aula primero.', 'error');
                    return;
                }
                
                select.innerHTML = '<option value="">Seleccione un aula</option>' +
                    aulas.map(aula => {
                        const tipo = aula.esAulaOrdenadores ? 'üíª' : 'üìö';
                        return `<option value="${aula.id}">${tipo} ${aula.nombre} (Cap: ${aula.capacidad})</option>`;
                    }).join('');
            } catch (error) {
                select.innerHTML = '<option value="">‚ùå Error al cargar</option>';
                showAlert('Error al cargar las aulas: ' + error.message, 'error');
                console.error('Error cargando aulas:', error);
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('reservaAlert');
            alertDiv.innerHTML = `
                <div class="alert alert-${type === 'error' ? 'error' : 'success'}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        function addHorario() {
            const dia = document.getElementById('horarioDia').value;
            const sesion = document.getElementById('horarioSesion').value;
            const inicio = document.getElementById('horarioInicio').value;
            const fin = document.getElementById('horarioFin').value;

            if (!inicio || !fin) {
                alert('‚ö†Ô∏è Por favor completa las horas de inicio y fin');
                return;
            }

            if (inicio >= fin) {
                alert('‚ö†Ô∏è La hora de inicio debe ser anterior a la hora de fin');
                return;
            }

            const tramoHorario = {
                diasSemana: dia,
                sesionDia: parseInt(sesion),
                horarioInicio: inicio,
                horarioFin: fin
            };

            horariosTemp.push(tramoHorario);
            renderHorarios();
        }

        function renderHorarios() {
            const container = document.getElementById('horariosAdded');
            updateHorariosCount();

            if (horariosTemp.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 10px;">No hay horarios a√±adidos</p>';
                return;
            }

            container.innerHTML = horariosTemp.map((h, index) => `
                <div class="tramoHorario-added">
                    <div class="tramoHorario-info">
                        <strong>${h.diasSemana}</strong> - Sesi√≥n ${h.sesionDia} | ‚è∞ ${h.horarioInicio} - ${h.horarioFin}
                    </div>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeHorario(${index})">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function updateHorariosCount() {
            const countElement = document.getElementById('horariosCount');
            const count = horariosTemp.length;
            countElement.textContent = `${count} ${count === 1 ? 'tramoHorario' : 'horarios'}`;
        }

        function removeHorario(index) {
            horariosTemp.splice(index, 1);
            renderHorarios();
        }

        async function saveAula(event) {
            event.preventDefault();
            
            const data = {
                nombre: document.getElementById('aulaNombre').value.trim(),
                capacidad: parseInt(document.getElementById('aulaCapacidad').value),
                esAulaOrdenadores: document.getElementById('aulaEsOrdenadores').checked,
                numeroOrdenadores: parseInt(document.getElementById('aulaNumOrdenadores').value) || 0
            };

            try {
                const url = editingId ? `${API_BASE}/aula/${editingId}` : `${API_BASE}/aula`;
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Error al guardar el aula');
                }
                
                closeModal('aulaModal');
                loadAulas();
                alert('‚úÖ Aula guardada correctamente');
            } catch (error) {
                alert('‚ùå Error al guardar el aula: ' + error.message);
                console.error('Error:', error);
            }
        }

        async function saveReserva(event) {
            event.preventDefault();
            
            const aulaId = document.getElementById('reservaAula').value;
            
            if (!aulaId) {
                showAlert('‚ö†Ô∏è Por favor selecciona un aula', 'error');
                return;
            }

            if (horariosTemp.length === 0) {
                if (!confirm('‚ö†Ô∏è No has a√±adido ning√∫n tramoHorario. ¬øDeseas continuar sin horarios?')) {
                    return;
                }
            }

            const horariosLimpios = horariosTemp.map(h => ({
                diasSemana: h.diasSemana,
                sesionDia: h.sesionDia,
                horarioInicio: h.horarioInicio,
                horarioFin: h.horarioFin
            }));

            const data = {
                fecha: document.getElementById('reservaFecha').value,
                motivo: document.getElementById('reservaMotivo').value.trim(),
                numeroAsistentes: parseInt(document.getElementById('reservaAsistentes').value),
                aula: { id: parseInt(aulaId) },
                tramoHorario: horariosLimpios
            };

            try {
                const url = editingId ? `${API_BASE}/reserva/${editingId}` : `${API_BASE}/reserva`;
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Error al guardar la reserva');
                }
                
                closeModal('reservaModal');
                loadReservas();
                alert('‚úÖ Reserva guardada correctamente');
            } catch (error) {
                showAlert('‚ùå Error al guardar la reserva: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        async function editAula(id) {
            const aula = aulasData.find(a => a.id === id);
            if (!aula) return;
            
            editingId = id;
            document.getElementById('aulaModalTitle').textContent = 'Editar Aula';
            document.getElementById('aulaNombre').value = aula.nombre;
            document.getElementById('aulaCapacidad').value = aula.capacidad;
            document.getElementById('aulaEsOrdenadores').checked = aula.esAulaOrdenadores;
            document.getElementById('aulaNumOrdenadores').value = aula.numeroOrdenadores || 0;
            toggleOrdenadores();
            document.getElementById('aulaModal').classList.add('active');
        }

        async function editReserva(id) {
            const reserva = reservasData.find(r => r.id === id);
            if (!reserva) return;
            
            editingId = id;
            horariosTemp = reserva.tramoHorario ? [...reserva.tramoHorario] : [];
            
            document.getElementById('reservaModalTitle').textContent = 'Editar Reserva';
            document.getElementById('reservaMotivo').value = reserva.motivo;
            document.getElementById('reservaFecha').value = reserva.fecha;
            document.getElementById('reservaAsistentes').value = reserva.numeroAsistentes;
            document.getElementById('reservaAlert').innerHTML = '';
            
            await loadAulasSelect();
            document.getElementById('reservaAula').value = reserva.aula ? reserva.aula.id : '';
            
            renderHorarios();
            document.getElementById('reservaModal').classList.add('active');
        }

        async function deleteAula(id) {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar esta aula?\n\nEsta acci√≥n tambi√©n eliminar√° todas sus reservas asociadas.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/aula/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Error al eliminar');
                
                loadAulas();
                alert('‚úÖ Aula eliminada correctamente');
            } catch (error) {
                alert('‚ùå Error al eliminar el aula: ' + error.message);
                console.error('Error:', error);
            }
        }

        async function deleteReserva(id) {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar esta reserva?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/reserva/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Error al eliminar');
                
                loadReservas();
                alert('‚úÖ Reserva eliminada correctamente');
            } catch (error) {
                alert('‚ùå Error al eliminar la reserva: ' + error.message);
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
                